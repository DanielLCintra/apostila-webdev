<!-- ==================== Aula React 11 - API Backend com PostgreSQL no Next.js ==================== -->
<article class="lesson-content">
  <h2>
    <i class="fas fa-server"></i> React ‚Äì Criando API Backend com PostgreSQL no
    Next.js
  </h2>

  <div class="intro-box mb-5">
    <p>
      <strong
        >üöÄ Transforme seu projeto em uma aplica√ß√£o full-stack completa!</strong
      >
    </p>
    <p>
      Nesta aula vamos evoluir nosso projeto de contatos para usar um backend
      real com PostgreSQL. Voc√™ aprender√° a criar APIs RESTful dentro do
      Next.js, conectar com banco de dados PostgreSQL no AWS RDS, criar
      migrations para estruturar o banco, e adaptar o front-end para consumir
      sua pr√≥pria API ao inv√©s do MockAPI.
    </p>
    <ul>
      <li>‚úÖ Subir API completa dentro do Next.js usando API Routes</li>
      <li>‚úÖ Conectar com PostgreSQL usando AWS RDS (inst√¢ncia gratuita)</li>
      <li>‚úÖ Criar migrations para estruturar banco de dados</li>
      <li>‚úÖ Implementar endpoints CRUD completos para contatos</li>
      <li>‚úÖ Criar endpoint de autentica√ß√£o (login de usu√°rios)</li>
      <li>‚úÖ Adaptar front-end para consumir a nova API</li>
      <li>‚úÖ Substituir MockAPI por API pr√≥pria</li>
    </ul>
  </div>

  <blockquote>
    <p>
      "Full-stack √© sobre construir pontes entre frontend e backend de forma
      elegante e eficiente." - Next.js Team
    </p>
  </blockquote>

  <div class="alert alert-info">
    <strong>Pr√©-requisito:</strong> Projeto da aula anterior "React ‚Äì Consumo de
    API com axios e useEffect" funcionando com MockAPI, Context, hooks
    customizados, cache offline e sincroniza√ß√£o.
  </div>

  <div class="alert alert-warning">
    <strong>üîß Configura√ß√£o do PostgreSQL AWS RDS:</strong> Para esta aula,
    vamos usar as seguintes credenciais do banco de dados:
    <ul>
      <li><strong>Database:</strong> contacts_db</li>
      <li><strong>User:</strong> contacts</li>
      <li><strong>Password:</strong> contacts_2025#</li>
      <li>
        <strong>Host:</strong>
        contacts-db.cqub0jviveo4.us-east-1.rds.amazonaws.com
      </li>
      <li><strong>Port:</strong> 5432</li>
    </ul>
  </div>

  <!-- 1. Introdu√ß√£o ao Backend no Next.js -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-code"></i> 1. Introdu√ß√£o ao Backend no Next.js
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>1.1 O que s√£o API Routes?</h4>
        <p>
          As <strong>API Routes</strong> do Next.js permitem criar endpoints de
          API diretamente dentro do projeto, sem precisar de um servidor
          separado. Cada arquivo dentro da pasta <code>app/api/</code> se torna
          um endpoint HTTP.
        </p>

        <h5>Estrutura de pastas:</h5>
        <pre><code class="language-plaintext">app/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ contacts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.js        # GET /api/contacts (listar)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.js    # GET /api/contacts/123, PUT, DELETE
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.js    # POST /api/auth/login
‚îÇ   ‚îî‚îÄ‚îÄ health/
‚îÇ       ‚îî‚îÄ‚îÄ route.js        # GET /api/health (status do servidor)
‚îú‚îÄ‚îÄ components/
‚îî‚îÄ‚îÄ ...</code></pre>

        <h4>1.2 Vantagens de usar API Routes no Next.js</h4>
        <ul>
          <li>
            <strong>Full-stack em um s√≥ projeto:</strong> Frontend e backend no
            mesmo c√≥digo
          </li>
          <li><strong>Deploy unificado:</strong> Tudo sobe junto no Vercel</li>
          <li>
            <strong>Simplicidade:</strong> N√£o precisa gerenciar dois projetos
            separados
          </li>
          <li>
            <strong>Produtividade:</strong> Desenvolvimento mais r√°pido e
            integrado
          </li>
          <li><strong>Type-safe:</strong> TypeScript funciona end-to-end</li>
        </ul>

        <h4>1.3 M√©todos HTTP suportados</h4>
        <p>
          Cada arquivo <code>route.js</code> pode exportar fun√ß√µes para
          diferentes m√©todos HTTP:
        </p>
        <pre><code class="language-js">// app/api/contacts/route.js
export async function GET(request) {
  // Buscar todos os contatos
  return Response.json({ contacts: [] });
}

export async function POST(request) {
  // Criar novo contato
  return Response.json({ success: true });
}</code></pre>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Dica:</strong> No Next.js 13+ (App Router), usamos
          <code>async function GET/POST/PUT/DELETE</code> ao inv√©s de
          <code>export default function handler(req, res)</code> do Pages
          Router.
        </div>
      </div>
    </div>
  </section>

  <!-- 2. Instalando e Configurando PostgreSQL -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-download"></i> 2. Instalando e Configurando PostgreSQL
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>2.1 Instalar depend√™ncias</h4>
        <p>Primeiro, vamos instalar o cliente PostgreSQL para Node.js:</p>

        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">cd contatos
npm install pg --save
npm install dotenv --save-dev</code></pre>

        <div class="alert alert-info mt-3">
          <strong>üì¶ Depend√™ncias:</strong>
          <ul>
            <li><strong>pg:</strong> Cliente PostgreSQL para Node.js</li>
            <li>
              <strong>dotenv:</strong> Para gerenciar vari√°veis de ambiente
            </li>
          </ul>
        </div>

        <h4>2.2 Configurar vari√°veis de ambiente</h4>
        <p>Vamos criar arquivos para gerenciar as credenciais do banco:</p>

        <h5>üìÅ Arquivo: .env.local</h5>
        <pre><code class="language-plaintext"># Banco de Dados PostgreSQL AWS RDS
DATABASE_URL=postgresql://contacts:contacts_2025%23@contacts-db.cqub0jviveo4.us-east-1.rds.amazonaws.com:5432/contacts_db

# Vari√°veis individuais (opcional, para referencia)
DB_HOST=contacts-db.cqub0jviveo4.us-east-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=contacts_db
DB_USER=contacts
DB_PASSWORD=contacts_2025#</code></pre>

        <div class="alert alert-warning mt-3">
          <strong>‚ö†Ô∏è Importante:</strong> O arquivo <code>.env.local</code> N√ÉO
          deve ser commitado no git! Adicione ao <code>.gitignore</code>.
        </div>

        <h5>üìÅ Arquivo: .gitignore (adicionar linhas)</h5>
        <pre><code class="language-plaintext"># Vari√°veis de ambiente
.env
.env.local
.env.production</code></pre>

        <h4>2.3 Criar arquivo de conex√£o com o banco</h4>
        <p>Vamos criar um arquivo para gerenciar a conex√£o com PostgreSQL:</p>

        <h5>üìÅ Arquivo: app/lib/db.js</h5>
        <pre><code class="language-js">// app/lib/db.js
import pkg from 'pg';
const { Pool } = pkg;

// Configura√ß√£o do pool de conex√µes usando DATABASE_URL
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
        rejectUnauthorized: false // Necess√°rio para AWS RDS
    }
});

// Fun√ß√£o de teste de conex√£o
async function testConnection() {
    try {
        const client = await pool.connect();
        console.log('‚úÖ Conectado ao banco de dados PostgreSQL');
        client.release();
        return true;
    } catch (err) {
        console.error('‚ùå Erro ao conectar ao banco:', err.message);
        return false;
    }
}

export {
    pool,
    testConnection
};</code></pre>

        <div class="alert alert-info mt-3">
          <strong>üìå O que √© um Pool?</strong> O pool gerencia m√∫ltiplas
          conex√µes ao banco, melhorando performance e evitando overhead de
          criar/fechar conex√µes a cada requisi√ß√£o.
        </div>
      </div>
    </div>
  </section>

  <!-- 3. Criar Migrations e Tabelas -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-database"></i> 3. Criar Migrations e Tabelas
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>3.1 Estrutura das tabelas</h4>
        <p>Vamos criar duas tabelas no banco:</p>

        <h5>Tabela: users</h5>
        <pre><code class="language-sql">CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  role VARCHAR(50) DEFAULT 'user',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);</code></pre>

        <h5>Tabela: contacts</h5>
        <pre><code class="language-sql">CREATE TABLE contacts (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(100),
  telephone VARCHAR(20),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);</code></pre>

        <h4>3.2 Script de migration manual</h4>
        <p>Crie um script para rodar as migrations:</p>

        <h5>üìÅ Arquivo: app/lib/migrate.js</h5>
        <pre><code class="language-js">// app/lib/migrate.js
require('dotenv').config({ path: '.env.local' });
const { Pool } = require('pg');

async function runMigrations() {
  try {
    console.log('üîÑ Iniciando migrations...');

    // Conectar ao banco de dados padr√£o para criar o banco se n√£o existir
    const adminUrl = process.env.DATABASE_URL.replace(process.env.DB_NAME, 'postgres');
    const adminPool = new Pool({
        connectionString: adminUrl,
        ssl: {
            rejectUnauthorized: false
        }
    });

    // Verificar e criar o banco de dados
    const dbCheck = await adminPool.query(
        `SELECT 1 FROM pg_database WHERE datname = $1`,
        [process.env.DB_NAME]
    );

    if (dbCheck.rows.length === 0) {
        await adminPool.query(`CREATE DATABASE ${process.env.DB_NAME}`);
        console.log(`‚úÖ Banco de dados ${process.env.DB_NAME} criado`);
    } else {
        console.log(`‚ÑπÔ∏è  Banco de dados ${process.env.DB_NAME} j√° existe`);
    }

    await adminPool.end();

    // Agora usar o pool normal para criar as tabelas
    const { pool } = require('./db');

    // Criar tabela users
    await pool.query(`
      CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        email VARCHAR(100) NOT NULL UNIQUE,
        password VARCHAR(255) NOT NULL,
        role VARCHAR(50) DEFAULT 'user',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
    console.log('‚úÖ Tabela users criada');

    // Verificar e adicionar campo email se n√£o existir
    const emailColumnCheck = await pool.query(`
        SELECT column_name 
        FROM information_schema.columns 
        WHERE table_name='users' AND column_name='email'
    `);

    if (emailColumnCheck.rows.length === 0) {
        await pool.query('ALTER TABLE users ADD COLUMN email VARCHAR(100) UNIQUE');
        console.log('‚úÖ Campo email adicionado √† tabela users');
    }

    // Criar tabela contacts
    await pool.query(`
      CREATE TABLE IF NOT EXISTS contacts (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        email VARCHAR(100),
        telephone VARCHAR(20),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
    console.log('‚úÖ Tabela contacts criada');

    // Inserir usu√°rios de teste
    const testUsers = [
      { name: 'Administrador', email: 'admin@contatos.com', password: '123456', role: 'admin' },
      { name: 'Usu√°rio Teste', email: 'user@contatos.com', password: 'senha123', role: 'user' },
      { name: 'Demo', email: 'demo@contatos.com', password: 'demo123', role: 'user' }
    ];

    for (const user of testUsers) {
      const existingUser = await pool.query(
        'SELECT id FROM users WHERE email = $1',
        [user.email]
      );

      if (existingUser.rows.length === 0) {
        await pool.query(
          'INSERT INTO users (name, email, password, role) VALUES ($1, $2, $3, $4)',
          [user.name, user.email, user.password, user.role]
        );
        console.log(`‚úÖ Usu√°rio ${user.name} (${user.email}) inserido`);
      }
    }

    console.log('üéâ Migrations conclu√≠das com sucesso!');
    process.exit(0);
  } catch (err) {
    console.error('‚ùå Erro nas migrations:', err);
    process.exit(1);
  }
}

runMigrations();</code></pre>

        <h4>3.3 Adicionar script de migration</h4>
        <p>
          Vamos adicionar um script no <code>package.json</code> para facilitar
          a execu√ß√£o das migrations:
        </p>

        <h5>üìÅ Arquivo: package.json</h5>
        <pre><code class="language-json">{
  "name": "contatos",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "migrate": "node app/lib/migrate.js"
  },
  ...
}</code></pre>

        <div class="alert alert-info mt-3">
          <strong>üìù O que fazemos:</strong> Adicionamos a linha
          <code>"migrate": "node lib/migrate.js"</code> na se√ß√£o de scripts.
          Isso permite executar as migrations com um comando simples.
        </div>

        <h4>3.4 Rodar as migrations</h4>
        <p>Agora vamos executar o script de migration usando npm:</p>

        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">cd contatos
npm run migrate</code></pre>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Resultado esperado:</strong>
          <pre><code>üîÑ Iniciando migrations...
‚úÖ Tabela users criada
‚úÖ Tabela contacts criada
‚úÖ Usu√°rio Administrador inserido
‚úÖ Usu√°rio Usu√°rio Teste inserido
üéâ Migrations conclu√≠das com sucesso!</code></pre>
        </div>

        <h4>3.5 Verificar as tabelas</h4>
        <p>
          Para confirmar que as tabelas foram criadas, voc√™ pode usar um cliente
          SQL como DBeaver, pgAdmin ou DataGrip conectado ao banco AWS RDS.
        </p>

        <div class="alert alert-info mt-3">
          <strong>üí° Comandos √∫teis do projeto:</strong>
          <ul>
            <li><code>npm run migrate</code> - Executar migrations do banco</li>
            <li>
              <code>npm run dev</code> - Iniciar servidor de desenvolvimento
            </li>
            <li><code>npm run build</code> - Build para produ√ß√£o</li>
            <li><code>npm run start</code> - Iniciar servidor de produ√ß√£o</li>
            <li><code>npm run lint</code> - Executar linter do c√≥digo</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- 4. Criar Endpoints de API -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-plug"></i> 4. Criar Endpoints de API
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>4.1 Endpoint: Listar Todos os Contatos</h4>
        <p>Crie o arquivo para listar todos os contatos:</p>

        <h5>üìÅ Arquivo: app/api/contacts/route.js</h5>
        <pre><code class="language-js">// app/api/contacts/route.js
import { pool } from '../../lib/db';

// GET /api/contacts - Listar todos os contatos
export async function GET(request) {
  try {
    const result = await pool.query(
      'SELECT id, name, email, telephone, created_at FROM contacts ORDER BY id DESC'
    );

    return Response.json({
      success: true,
      data: result.rows
    }, { status: 200 });
  } catch (error) {
    console.error('Erro ao listar contatos:', error);
    return Response.json({
      success: false,
      message: 'Erro ao buscar contatos',
      error: error.message
    }, { status: 500 });
  }
}

// POST /api/contacts - Criar novo contato
export async function POST(request) {
  try {
    const { name, email, telephone } = await request.json();

    // Valida√ß√£o
    if (!name) {
      return Response.json({
        success: false,
        message: 'Nome √© obrigat√≥rio'
      }, { status: 400 });
    }

    const result = await pool.query(
      'INSERT INTO contacts (name, email, telephone) VALUES ($1, $2, $3) RETURNING id, name, email, telephone, created_at',
      [name, email || null, telephone || null]
    );

    return Response.json({
      success: true,
      data: result.rows[0]
    }, { status: 201 });
  } catch (error) {
    console.error('Erro ao criar contato:', error);
    return Response.json({
      success: false,
      message: 'Erro ao criar contato',
      error: error.message
    }, { status: 500 });
  }
}</code></pre>

        <h4>4.2 Endpoint: Opera√ß√µes em Contato Espec√≠fico</h4>
        <p>Crie o arquivo para opera√ß√µes em um contato espec√≠fico:</p>

        <h5>üìÅ Arquivo: app/api/contacts/[id]/route.js</h5>
        <pre><code class="language-js">// app/api/contacts/[id]/route.js
import { pool } from '../../../lib/db';

// GET /api/contacts/:id - Buscar um contato
export async function GET(request, { params }) {
  try {
    const { id } = params;

    const result = await pool.query(
      'SELECT id, name, email, telephone, created_at FROM contacts WHERE id = $1',
      [id]
    );

    if (result.rows.length === 0) {
      return Response.json({
        success: false,
        message: 'Contato n√£o encontrado'
      }, { status: 404 });
    }

    return Response.json({
      success: true,
      data: result.rows[0]
    }, { status: 200 });
  } catch (error) {
    console.error('Erro ao buscar contato:', error);
    return Response.json({
      success: false,
      message: 'Erro ao buscar contato',
      error: error.message
    }, { status: 500 });
  }
}

// PUT /api/contacts/:id - Atualizar um contato
export async function PUT(request, { params }) {
  try {
    const { id } = params;
    const { name, email, telephone } = await request.json();

    // Valida√ß√£o
    if (!name) {
      return Response.json({
        success: false,
        message: 'Nome √© obrigat√≥rio'
      }, { status: 400 });
    }

    const result = await pool.query(
      'UPDATE contacts SET name = $1, email = $2, telephone = $3 WHERE id = $4 RETURNING id, name, email, telephone, created_at',
      [name, email || null, telephone || null, id]
    );

    if (result.rows.length === 0) {
      return Response.json({
        success: false,
        message: 'Contato n√£o encontrado'
      }, { status: 404 });
    }

    return Response.json({
      success: true,
      data: result.rows[0]
    }, { status: 200 });
  } catch (error) {
    console.error('Erro ao atualizar contato:', error);
    return Response.json({
      success: false,
      message: 'Erro ao atualizar contato',
      error: error.message
    }, { status: 500 });
  }
}

// DELETE /api/contacts/:id - Deletar um contato
export async function DELETE(request, { params }) {
  try {
    const { id } = params;

    const result = await pool.query(
      'DELETE FROM contacts WHERE id = $1 RETURNING id',
      [id]
    );

    if (result.rows.length === 0) {
      return Response.json({
        success: false,
        message: 'Contato n√£o encontrado'
      }, { status: 404 });
    }

    return Response.json({
      success: true,
      message: 'Contato deletado com sucesso'
    }, { status: 200 });
  } catch (error) {
    console.error('Erro ao deletar contato:', error);
    return Response.json({
      success: false,
      message: 'Erro ao deletar contato',
      error: error.message
    }, { status: 500 });
  }
}</code></pre>

        <h4>4.3 Endpoint: Login de Usu√°rios</h4>
        <p>Crie o arquivo para autentica√ß√£o:</p>

        <h5>üìÅ Arquivo: app/api/auth/login/route.js</h5>
        <pre><code class="language-js">// app/api/auth/login/route.js
import { pool } from '../../../lib/db';

// POST /api/auth/login - Login de usu√°rios
export async function POST(request) {
  try {
    const { email, password } = await request.json();

    // Valida√ß√£o
    if (!email || !password) {
      return Response.json({
        success: false,
        message: 'Email e senha s√£o obrigat√≥rios'
      }, { status: 400 });
    }

    // Buscar usu√°rio no banco
    const result = await pool.query(
      'SELECT id, name, email, password, role FROM users WHERE email = $1',
      [email]
    );

    if (result.rows.length === 0) {
      return Response.json({
        success: false,
        message: 'Usu√°rio n√£o encontrado'
      }, { status: 401 });
    }

    const user = result.rows[0];

    // Validar senha (compara√ß√£o simples - em produ√ß√£o usar bcrypt)
    if (user.password !== password) {
      return Response.json({
        success: false,
        message: 'Senha incorreta'
      }, { status: 401 });
    }

    // Remover senha da resposta
    delete user.password;

    return Response.json({
      success: true,
      data: {
        id: user.id,
        name: user.name,
        email: user.email,
        role: user.role,
        token: `token_${user.id}_${Date.now()}` // Token mockado
      }
    }, { status: 200 });
  } catch (error) {
    console.error('Erro ao fazer login:', error);
    return Response.json({
      success: false,
      message: 'Erro ao fazer login',
      error: error.message
    }, { status: 500 });
  }
}</code></pre>

        <div class="alert alert-warning mt-3">
          <strong>‚ö†Ô∏è Seguran√ßa:</strong> Em produ√ß√£o, sempre:
          <ul>
            <li>Use <code>bcrypt</code> para hash de senhas</li>
            <li>Use JWT tokens ao inv√©s de tokens mockados</li>
            <li>Implemente rate limiting</li>
            <li>Use HTTPS em todas as conex√µes</li>
          </ul>
        </div>

        <h4>4.4 Endpoint: Health Check</h4>
        <p>Crie um endpoint para verificar se a API est√° funcionando:</p>

        <h5>üìÅ Arquivo: app/api/health/route.js</h5>
        <pre><code class="language-js">// app/api/health/route.js
import { testConnection } from '../../lib/db';

// GET /api/health - Verificar status da API e banco
export async function GET() {
  const dbConnected = await testConnection();

  return Response.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    database: dbConnected ? 'connected' : 'disconnected'
  }, { status: dbConnected ? 200 : 503 });
}</code></pre>
      </div>
    </div>
  </section>

  <!-- 5. Testar os Endpoints -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-vials"></i> 5. Testar os Endpoints
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>5.1 Iniciar o servidor</h4>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">cd contatos
npm run dev</code></pre>

        <p>O servidor estar√° rodando em <code>http://localhost:3000</code></p>

        <h4>5.2 Testar Health Check</h4>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl http://localhost:3000/api/health</code></pre>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Resposta esperada:</strong>
          <pre><code>{
  "status": "ok",
  "timestamp": "2025-01-15T10:30:00.000Z",
  "database": "connected"
}</code></pre>
        </div>

        <h4>5.3 Testar Login</h4>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@contatos.com","password":"123456"}'</code></pre>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Resposta esperada:</strong>
          <pre><code>{
  "success": true,
  "data": {
    "id": 1,
    "name": "Administrador",
    "email": "admin@contatos.com",
    "role": "admin",
    "token": "token_1_1736948400000"
  }
}</code></pre>
        </div>

        <h4>5.4 Testar CRUD de Contatos</h4>

        <h5>a) Listar contatos (GET)</h5>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl http://localhost:3000/api/contacts</code></pre>

        <h5>b) Criar contato (POST)</h5>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl -X POST http://localhost:3000/api/contacts \
  -H "Content-Type: application/json" \
  -d '{"name":"Jo√£o Silva","email":"joao@email.com","telephone":"11999999999"}'</code></pre>

        <h5>c) Buscar contato espec√≠fico (GET)</h5>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl http://localhost:3000/api/contacts/1</code></pre>

        <h5>d) Atualizar contato (PUT)</h5>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl -X PUT http://localhost:3000/api/contacts/1 \
  -H "Content-Type: application/json" \
  -d '{"name":"Jo√£o Silva Atualizado","email":"joao.novo@email.com","telephone":"11888888888"}'</code></pre>

        <h5>e) Deletar contato (DELETE)</h5>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash">curl -X DELETE http://localhost:3000/api/contacts/1</code></pre>

        <div class="alert alert-info mt-3">
          <strong>üí° Dica:</strong> Voc√™ tamb√©m pode usar ferramentas gr√°ficas
          como Postman, Insomnia ou Thunder Client (VS Code) para testar os
          endpoints de forma mais visual.
        </div>

        <h4>5.5 Importar Collection do Postman</h4>
        <p>
          Para facilitar os testes, criamos uma collection completa do Postman
          com todos os endpoints:
        </p>

        <div class="alert alert-info mb-3">
          <strong>üì• Download da Collection:</strong>
          <a
            href="assets/json/Contacts App.postman_collection.json"
            download="Contacts App.postman_collection.json"
            class="btn btn-primary ml-2"
          >
            <i class="fas fa-download"></i> Baixar Collection do Postman
          </a>
        </div>

        <ol>
          <li>
            Clique no bot√£o de download acima para baixar o arquivo da
            collection
          </li>
          <li>
            Abra o Postman no seu computador (baixe em
            <a href="https://www.postman.com/downloads/" target="_blank"
              >postman.com</a
            >
            se n√£o tiver)
          </li>
          <li>
            Clique em <strong>"Import"</strong> no canto superior esquerdo
          </li>
          <li>
            Selecione o arquivo
            <code>Contacts App.postman_collection.json</code> que voc√™ baixou
          </li>
          <li>A collection ser√° importada com todos os endpoints</li>
        </ol>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Endpoints inclu√≠dos na collection:</strong>
          <ul>
            <li>GET /api/contacts - Listar todos os contatos</li>
            <li>POST /api/contacts - Criar novo contato</li>
            <li>GET /api/contacts/:id - Buscar contato por ID</li>
            <li>PUT /api/contacts/:id - Atualizar contato</li>
            <li>DELETE /api/contacts/:id - Deletar contato</li>
            <li>POST /api/auth/login - Login</li>
          </ul>
        </div>

        <div class="alert alert-warning mt-3">
          <strong>‚ö†Ô∏è Importante:</strong> Antes de usar a collection,
          certifique-se de que o servidor est√° rodando com
          <code>npm run dev</code> e ajuste o campo de login para usar
          <code>email</code> ao inv√©s de <code>name</code>:
          <pre><code>{
  "email": "admin@contatos.com",
  "password": "123456"
}</code></pre>
        </div>

        <p><strong>Como usar:</strong></p>
        <ol>
          <li>
            Clique em qualquer endpoint na collection do Postman para expandir
          </li>
          <li>Clique em <strong>"Send"</strong> para executar a requisi√ß√£o</li>
          <li>Veja a resposta no painel inferior</li>
          <li>Ajuste par√¢metros (como ID) nas vari√°veis quando necess√°rio</li>
        </ol>
      </div>
    </div>
  </section>

  <!-- 6. Adaptar Front-end para Nova API -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-sync-alt"></i> 6. Adaptar Front-end para Nova API
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>6.1 Atualizar arquivo api.js</h4>
        <p>Vamos mudar o <code>baseURL</code> do axios para nossa API local:</p>

        <h5>üìÅ Arquivo: app/utils/api.js</h5>
        <pre><code class="language-js">// app/utils/api.js
import axios from 'axios';

// Configura√ß√£o base do axios - NOVA API LOCAL
const api = axios.create({
    baseURL: '/api', // ‚úÖ NOVA API LOCAL (Next.js j√° est√° na mesma origem)
    timeout: 10000,
    headers: {
        'Content-Type': 'application/json',
    },
    validateStatus: function (status) {
        return status < 500; // Resolver sempre que a resposta n√£o for um erro do servidor
    }
});

// Adicionar interceptors para tratamento global
api.interceptors.request.use(
    (config) => {
        console.log('Enviando requisi√ß√£o:', config.method, config.url);
        return config;
    },
    (error) => {
        return Promise.reject(error);
    }
);

api.interceptors.response.use(
    (response) => {
        console.log('Resposta recebida:', response.status);
        return response;
    },
    (error) => {
        console.error('Erro na requisi√ß√£o:', error.message);
        return Promise.reject(error);
    }
);

export default api;</code></pre>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Mudan√ßa principal:</strong> Alteramos de
          <code>https://68d96d1b90a75154f0da61ae.mockapi.io</code> para
          <code>/api</code> que funciona tanto em desenvolvimento quanto
          produ√ß√£o.
        </div>

        <h4>6.2 Adaptar ContactsContext para Nova API</h4>
        <p>A API que criamos retorna os dados em formato diferente:</p>

        <h5>üìÅ Arquivo: app/contexts/ContactsContext.js</h5>
        <p>
          Voc√™ precisar√° adaptar as chamadas para extrair
          <code>response.data.data</code> ao inv√©s de
          <code>response.data</code>:
        </p>

        <pre><code class="language-js">// ANTES (MockAPI):
const response = await api.get('/contacts');
const apiContacts = response.data; // Array direto

// DEPOIS (Nossa API):
const response = await api.get('/contacts');
const apiContacts = response.data.data; // Array dentro de { success: true, data: [...] }</code></pre>

        <h5>Exemplo de adapta√ß√£o completa:</h5>

        <pre><code class="language-js">// app/contexts/ContactsContext.js - Fun√ß√£o loadContacts
const loadContacts = useCallback(async () => {
    try {
        setLoading(true);
        setError(null);

        const response = await api.get('/contacts');
        
        // üÜï ADAPTAR: Extrair data.data ao inv√©s de data
        if (response.data.success) {
            setContacts(response.data.data);
            setIsOffline(false);
        } else {
            throw new Error(response.data.message);
        }
    } catch (err) {
        console.error('Erro ao carregar contatos:', err);
        setError('Erro ao carregar contatos');
        setIsOffline(true);
    } finally {
        setLoading(false);
    }
}, []);</code></pre>

        <h4>6.3 Adaptar addContact</h4>
        <pre><code class="language-js">// app/contexts/ContactsContext.js - Fun√ß√£o addContact
const addContact = useCallback(async (newContact) => {
    try {
        const response = await api.post('/contacts', newContact);
        
        // üÜï ADAPTAR: Extrair data.data
        if (response.data.success) {
            const contactWithId = response.data.data;
            setContacts(prev => [...prev, contactWithId]);
            return contactWithId;
        } else {
            throw new Error(response.data.message);
        }
    } catch (err) {
        console.error('Erro ao adicionar contato:', err);
        throw new Error('Erro ao adicionar contato');
    }
}, []);</code></pre>

        <h4>6.4 Adaptar AuthContext</h4>
        <p>Adapte o login para usar a nova API:</p>

        <pre><code class="language-js">// app/contexts/AuthContext.js - Fun√ß√£o login
const login = useCallback(async (email, password) => {
    try {
        setLoading(true);
        setError(null);

        // üÜï NOVA CHAMADA PARA API
        const response = await api.post('/auth/login', {
            email,
            password
        });

        if (response.data.success) {
            const { id, name, email, role, token } = response.data.data;

            // Salvar no localStorage
            localStorage.setItem('authToken', token);
            localStorage.setItem('userData', JSON.stringify({
                id,
                name,
                role
            }));

            setUser({ id, name, role });

            return { success: true };
        } else {
            throw new Error(response.data.message);
        }
    } catch (err) {
        setError(err.response?.data?.message || 'Erro ao fazer login');
        throw err;
    } finally {
        setLoading(false);
    }
}, []);</code></pre>

        <div class="alert alert-info mt-3">
          <strong>üìå Mudan√ßas necess√°rias:</strong>
          <ul>
            <li>
              Alterar <code>response.data</code> para
              <code>response.data.data</code>
            </li>
            <li>Verificar <code>response.data.success</code> antes de usar</li>
            <li>
              Lidar com mensagens de erro de <code>response.data.message</code>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- 7. Quiz -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-clipboard-check"></i> 7. Teste seus Conhecimentos (Quiz)
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <ol>
          <li class="mb-3">
            Qual √© a principal vantagem de usar API Routes no Next.js ao inv√©s
            de criar um backend separado?
            <div>
              a) Melhor performance &nbsp; b) Full-stack em um s√≥ projeto com
              deploy unificado &nbsp; c) Mais seguro &nbsp; d) Mais r√°pido
            </div>
          </li>
          <li class="mb-3">
            Por que usamos um pool de conex√µes ao inv√©s de criar uma conex√£o a
            cada requisi√ß√£o?
            <div>
              a) √â mais seguro &nbsp; b) Melhor performance, evita overhead
              &nbsp; c) Mais simples &nbsp; d) N√£o tem diferen√ßa
            </div>
          </li>
          <li class="mb-3">
            O que faz o c√≥digo <code>CREATE DATABASE IF NOT EXISTS</code> no
            script de migration?
            <div>
              a) Deleta o banco se existir &nbsp; b) Verifica e cria o banco se
              n√£o existir &nbsp; c) Atualiza o banco &nbsp; d) Backup do banco
            </div>
          </li>
          <li class="mb-3">
            Por que usamos <code>/api</code> ao inv√©s de
            <code>http://localhost:3000/api</code> no axios?
            <div>
              a) √â mais curto &nbsp; b) Funciona em dev e produ√ß√£o
              automaticamente &nbsp; c) Mais seguro &nbsp; d) Mais r√°pido
            </div>
          </li>
          <li class="mb-3">
            Qual √© a diferen√ßa entre usar <code>response.data</code> e
            <code>response.data.data</code> na nossa API?
            <div>
              a) Nenhuma diferen√ßa &nbsp; b) Nossa API retorna
              <code>{success: true, data: [...]}</code>, ent√£o precisamos
              extrair data.data &nbsp; c) response.data.data √© mais r√°pido
              &nbsp; d) Sempre usa response.data.data
            </div>
          </li>
          <li class="mb-3">
            Por que adicionamos SSL com
            <code>rejectUnauthorized: false</code> na configura√ß√£o do pool?
            <div>
              a) Para desabilitar SSL &nbsp; b) Para aceitar certificados
              self-signed do AWS RDS &nbsp; c) Para melhorar performance &nbsp;
              d) Para debug
            </div>
          </li>
          <li class="mb-3">
            O que √© uma migration no contexto de banco de dados?
            <div>
              a) Uma c√≥pia do banco &nbsp; b) Um script que cria e estrutura o
              banco de dados &nbsp; c) Uma query SQL &nbsp; d) Um backup
            </div>
          </li>
        </ol>

        <details class="solucao">
          <summary>Mostrar gabarito</summary>
          <ol>
            <li>b) Full-stack em um s√≥ projeto com deploy unificado</li>
            <li>b) Melhor performance, evita overhead</li>
            <li>
              b) Verifica e cria o banco se n√£o existir (embora PostgreSQL use
              outra sintaxe)
            </li>
            <li>b) Funciona em dev e produ√ß√£o automaticamente</li>
            <li>
              b) Nossa API retorna <code>{success: true, data: [...]}</code>,
              ent√£o precisamos extrair data.data
            </li>
            <li>b) Para aceitar certificados self-signed do AWS RDS</li>
            <li>b) Um script que cria e estrutura o banco de dados</li>
          </ol>
        </details>
      </div>
    </div>
  </section>

  <!-- 8. Exerc√≠cios Pr√°ticos -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-chalkboard-teacher"></i> 8. Exerc√≠cios Pr√°ticos
    </h3>

    <div class="desafio">
      <h4>Exerc√≠cio 1: Implementar Busca e Filtros na API</h4>
      <p>
        <strong>Objetivo:</strong> Adicionar funcionalidade de busca na API de
        contatos.
      </p>
      <ol>
        <li>
          Criar novo endpoint <code>GET /api/contacts/search?q=termo</code>
        </li>
        <li>Buscar contatos por nome, email ou telefone</li>
        <li>Usar ILIKE para busca case-insensitive</li>
        <li>Retornar array de contatos que correspondam ao termo de busca</li>
        <li>Testar com curl ou Postman</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// app/api/contacts/search/route.js
import { pool } from '../../../../lib/db';

export async function GET(request) {
    const { searchParams } = new URL(request.url);
    const query = searchParams.get('q');

    if (!query) {
        return Response.json({
            success: false,
            message: 'Par√¢metro de busca √© obrigat√≥rio'
        }, { status: 400 });
    }

    try {
        const result = await pool.query(
            `SELECT id, name, email, telephone, created_at 
            FROM contacts 
            WHERE name ILIKE $1 OR email ILIKE $1 OR telephone ILIKE $1
            ORDER BY name`,
            [`%${query}%`]
        );

        return Response.json({
            success: true,
            data: result.rows
        }, { status: 200 });
    } catch (error) {
        console.error('Erro na busca:', error);
        return Response.json({
            success: false,
            message: 'Erro ao buscar contatos'
        }, { status: 500 });
    }
}</code></pre>
        <p>
          <strong>Testar:</strong>
          <code>curl http://localhost:3000/api/contacts/search?q=joao</code>
        </p>
      </details>
    </div>

    <div class="desafio">
      <h4>Exerc√≠cio 2: Implementar Pagina√ß√£o</h4>
      <p>
        <strong>Objetivo:</strong> Adicionar pagina√ß√£o ao endpoint de listagem
        de contatos.
      </p>
      <ol>
        <li>
          Aceitar par√¢metros <code>page</code> e <code>limit</code> na query
          string
        </li>
        <li>Calcular offset com base na p√°gina</li>
        <li>Usar LIMIT e OFFSET na query SQL</li>
        <li>Retornar total de registros e metadados de pagina√ß√£o</li>
        <li>Implementar no front-end para exibir contatos paginados</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// Adaptar app/api/contacts/route.js
export async function GET(request) {
    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '10');
    const offset = (page - 1) * limit;

    try {
        // Buscar total de registros
        const countResult = await pool.query('SELECT COUNT(*) FROM contacts');
        const total = parseInt(countResult.rows[0].count);

        // Buscar contatos paginados
        const result = await pool.query(
            'SELECT id, name, email, telephone, created_at FROM contacts ORDER BY id DESC LIMIT $1 OFFSET $2',
            [limit, offset]
        );

        return Response.json({
            success: true,
            data: result.rows,
            pagination: {
                page,
                limit,
                total,
                totalPages: Math.ceil(total / limit)
            }
        }, { status: 200 });
    } catch (error) {
        console.error('Erro ao listar contatos:', error);
        return Response.json({
            success: false,
            message: 'Erro ao buscar contatos'
        }, { status: 500 });
    }
}</code></pre>
      </details>
    </div>

    <div class="desafio">
      <h4>Exerc√≠cio 3: Adicionar Valida√ß√£o de Dados</h4>
      <p>
        <strong>Objetivo:</strong> Implementar valida√ß√£o robusta dos dados
        recebidos pela API.
      </p>
      <ol>
        <li>Criar fun√ß√£o de valida√ß√£o de email com regex</li>
        <li>Validar formato de telefone</li>
        <li>Validar que nome n√£o est√° vazio</li>
        <li>Retornar erros espec√≠ficos para cada campo inv√°lido</li>
        <li>Reutilizar valida√ß√µes nos endpoints CREATE e UPDATE</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// lib/validators.js
export function validateContact(contact) {
    const errors = [];

    // Validar nome
    if (!contact.name || contact.name.trim().length === 0) {
        errors.push({ field: 'name', message: 'Nome √© obrigat√≥rio' });
    }

    // Validar email (opcional, mas se informado deve ser v√°lido)
    if (contact.email && !isValidEmail(contact.email)) {
        errors.push({ field: 'email', message: 'Email inv√°lido' });
    }

    // Validar telefone (opcional, mas se informado deve ter formato)
    if (contact.telephone && !isValidPhone(contact.telephone)) {
        errors.push({ 
            field: 'telephone', 
            message: 'Telefone deve ter formato v√°lido' 
        });
    }

    return {
        isValid: errors.length === 0,
        errors
    };
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function isValidPhone(phone) {
    const phoneRegex = /^[\d\s\(\)\-\+]+$/;
    return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
}

// Usar no endpoint
import { validateContact } from '../../../lib/validators';

export async function POST(request) {
    const contact = await request.json();
    
    const validation = validateContact(contact);
    if (!validation.isValid) {
        return Response.json({
            success: false,
            message: 'Dados inv√°lidos',
            errors: validation.errors
        }, { status: 400 });
    }
    
    // ... resto da l√≥gica
}</code></pre>
      </details>
    </div>

    <div class="desafio">
      <h4>Exerc√≠cio 4: Implementar Log de Auditoria</h4>
      <p>
        <strong>Objetivo:</strong> Criar tabela de logs para rastrear a√ß√µes no
        sistema.
      </p>
      <ol>
        <li>
          Criar tabela <code>audit_logs</code> com timestamp, user_id, action,
          table_name
        </li>
        <li>Criar middleware que loga cada opera√ß√£o CRUD na tabela contacts</li>
        <li>Endpoint para listar logs com filtros por data</li>
        <li>Adicionar coluna updated_at na tabela contacts</li>
        <li>Exibir hist√≥rico de modifica√ß√µes no front-end</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// Migration: Adicionar campo updated_at
ALTER TABLE contacts ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

// Migration: Criar tabela de logs
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    action VARCHAR(50),
    table_name VARCHAR(50),
    record_id INTEGER,
    details JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

// Middleware de log
export async function logAction(userId, action, tableName, recordId, details) {
    await pool.query(
        'INSERT INTO audit_logs (user_id, action, table_name, record_id, details) VALUES ($1, $2, $3, $4, $5)',
        [userId, action, tableName, recordId, JSON.stringify(details)]
    );
}

// Usar no endpoint
await logAction(null, 'UPDATE', 'contacts', id, { changes: {...} });</code></pre>
      </details>
    </div>

    <div class="desafio">
      <h4>Exerc√≠cio 5: Adicionar Endpoint de Estat√≠sticas</h4>
      <p>
        <strong>Objetivo:</strong> Criar API que retorna estat√≠sticas agregadas
        dos contatos.
      </p>
      <ol>
        <li>Criar endpoint <code>GET /api/contacts/stats</code></li>
        <li>
          Retornar: total de contatos, contatos por m√™s, contatos com email, sem
          telefone, etc.
        </li>
        <li>Usar SQL com COUNT, GROUP BY</li>
        <li>Criar componente no front-end para exibir gr√°ficos</li>
        <li>Atualizar estat√≠sticas em tempo real</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// app/api/contacts/stats/route.js
export async function GET() {
    try {
        const stats = {
            total: (await pool.query('SELECT COUNT(*) FROM contacts')).rows[0].count,
            comEmail: (await pool.query("SELECT COUNT(*) FROM contacts WHERE email IS NOT NULL AND email != ''")).rows[0].count,
            semTelefone: (await pool.query('SELECT COUNT(*) FROM contacts WHERE telephone IS NULL OR telephone = \'\'')).rows[0].count,
            porMes: (await pool.query(`
                SELECT DATE_TRUNC('month', created_at) as mes, COUNT(*) as total
                FROM contacts
                GROUP BY mes
                ORDER BY mes DESC
                LIMIT 12
            `)).rows
        };

        return Response.json({
            success: true,
            data: stats
        }, { status: 200 });
    } catch (error) {
        console.error('Erro ao buscar estat√≠sticas:', error);
        return Response.json({
            success: false,
            message: 'Erro ao buscar estat√≠sticas'
        }, { status: 500 });
    }
}</code></pre>
      </details>
    </div>

    <div class="desafio">
      <h4>Exerc√≠cio 6: Implementar Upload de Foto de Contato</h4>
      <p>
        <strong>Objetivo:</strong> Adicionar campo de foto aos contatos com
        upload.
      </p>
      <ol>
        <li>Adicionar coluna <code>photo_url</code> na tabela contacts</li>
        <li>
          Criar endpoint <code>POST /api/contacts/:id/photo</code> para upload
        </li>
        <li>Salvar imagem no servidor ou usar servi√ßo (Cloudinary, AWS S3)</li>
        <li>Retornar URL da foto ap√≥s upload</li>
        <li>Atualizar front-end para exibir fotos dos contatos</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// Migration
ALTER TABLE contacts ADD COLUMN photo_url TEXT;

// app/api/contacts/[id]/photo/route.js
import { writeFile } from 'fs/promises';
import path from 'path';

export async function POST(request, { params }) {
    const { id } = params;
    const formData = await request.formData();
    const file = formData.get('photo');

    if (!file) {
        return Response.json({
            success: false,
            message: 'Arquivo n√£o enviado'
        }, { status: 400 });
    }

    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);

    const filename = `${id}_${Date.now()}_${file.name}`;
    const filepath = path.join(process.cwd(), 'public/photos', filename);

    await writeFile(filepath, buffer);

    const photoUrl = `/photos/${filename}`;

    await pool.query(
        'UPDATE contacts SET photo_url = $1 WHERE id = $2',
        [photoUrl, id]
    );

    return Response.json({
        success: true,
        data: { photoUrl }
    }, { status: 200 });
}</code></pre>
      </details>
    </div>

    <div class="desafio">
      <h4>Exerc√≠cio 7: Melhorar Seguran√ßa com Rate Limiting</h4>
      <p>
        <strong>Objetivo:</strong> Implementar prote√ß√£o contra abuse de API.
      </p>
      <ol>
        <li>
          Instalar e configurar biblioteca de rate limiting (ex:
          <code>@upstash/ratelimit</code> ou implementar com Redis)
        </li>
        <li>Limitar 100 requisi√ß√µes por minuto por IP</li>
        <li>
          Adicionar middleware que verifica rate limit antes de processar
          requisi√ß√µes
        </li>
        <li>Retornar HTTP 429 quando limite for excedido</li>
        <li>Documentar limites para usu√°rios da API</li>
      </ol>
      <details class="solucao">
        <summary>Ver solu√ß√£o</summary>
        <pre><code class="language-js">// lib/rateLimit.js
const requestCounts = new Map();

export function rateLimit(request, maxRequests = 100, windowMs = 60000) {
    const ip = request.headers.get('x-forwarded-for') || 
               request.headers.get('x-real-ip') || 
               'unknown';
    
    const now = Date.now();
    const userRequests = requestCounts.get(ip) || [];

    // Remove requisi√ß√µes antigas
    const recentRequests = userRequests.filter(
        time => now - time < windowMs
    );

    if (recentRequests.length >= maxRequests) {
        return false;
    }

    recentRequests.push(now);
    requestCounts.set(ip, recentRequests);
    return true;
}

// Usar no endpoint
export async function POST(request) {
    if (!rateLimit(request, 100, 60000)) {
        return Response.json({
            success: false,
            message: 'Rate limit excedido'
        }, { status: 429 });
    }
    // ... resto do c√≥digo
}</code></pre>
      </details>
    </div>
  </section>

  <!-- 9. Deploy e Produ√ß√£o -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-rocket"></i> 9. Deploy e Produ√ß√£o
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>9.1 Vari√°veis de ambiente em produ√ß√£o</h4>
        <p>No Vercel, configure as vari√°veis de ambiente:</p>

        <ol>
          <li>Acesse o projeto no Vercel</li>
          <li>V√° em Settings ‚Üí Environment Variables</li>
          <li>
            Adicione as seguintes vari√°veis:
            <ul>
              <li>
                <code>DB_HOST</code>:
                contacts-db.cqub0jviveo4.us-east-1.rds.amazonaws.com
              </li>
              <li><code>DB_PORT</code>: 5432</li>
              <li><code>DB_NAME</code>: contacts_db</li>
              <li><code>DB_USER</code>: contacts</li>
              <li><code>DB_PASSWORD</code>: contacts_2025#</li>
            </ul>
          </li>
        </ol>

        <h4>9.2 Adaptar baseURL para produ√ß√£o</h4>
        <p>Crie uma vari√°vel de ambiente para a base da API:</p>

        <h5>üìÅ Arquivo: app/utils/api.js (vers√£o produ√ß√£o)</h5>
        <pre><code class="language-js">// app/utils/api.js
import axios from 'axios';

const api = axios.create({
    baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api',
    timeout: 10000,
    headers: {
        'Content-Type': 'application/json',
    },
});

// ... resto do c√≥digo</code></pre>

        <h5>üìÅ Arquivo: .env.local (produ√ß√£o)</h5>
        <pre><code class="language-plaintext"># URL da API (usa a mesma do Next.js por ser full-stack)
NEXT_PUBLIC_API_URL=https://seu-projeto.vercel.app/api</code></pre>

        <h4>9.3 Deploy no Vercel</h4>
        <div class="code-header">Terminal</div>
        <pre><code class="language-bash"># Commit e push
git add .
git commit -m "Adicionar API backend com PostgreSQL"
git push origin main

# Deploy autom√°tico no Vercel
# (conecte o reposit√≥rio no Vercel se ainda n√£o conectou)</code></pre>

        <div class="alert alert-success mt-3">
          <strong>‚úÖ Vantagens do deploy unificado:</strong>
          <ul>
            <li>Frontend e backend sobem juntos</li>
            <li>Uma √∫nica URL para tudo</li>
            <li>Gerenciamento simplificado</li>
            <li>Custo reduzido</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- 10. Resumo e Conclus√£o -->
  <section class="mb-5">
    <h3 class="section-title with-icon">
      <i class="fas fa-check-circle"></i> 10. Resumo e Conclus√£o
    </h3>
    <div class="card mb-4">
      <div class="card-body">
        <h4>O que voc√™ aprendeu nesta aula:</h4>
        <ul>
          <li>‚úÖ Criar API Routes no Next.js usando App Router</li>
          <li>‚úÖ Conectar com PostgreSQL usando o cliente pg</li>
          <li>‚úÖ Criar migrations para estruturar o banco de dados</li>
          <li>‚úÖ Implementar endpoints CRUD completos</li>
          <li>‚úÖ Criar endpoint de autentica√ß√£o</li>
          <li>‚úÖ Adaptar front-end para consumir a nova API</li>
          <li>‚úÖ Substituir MockAPI por API pr√≥pria</li>
          <li>‚úÖ Configurar vari√°veis de ambiente</li>
          <li>‚úÖ Deploy de aplica√ß√£o full-stack</li>
        </ul>

        <h4>Estrutura final do projeto:</h4>
        <pre><code class="language-plaintext">contatos/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/                    # üÜï API Routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contacts/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.js        # GET, POST /api/contacts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.js    # GET, PUT, DELETE /api/contacts/:id
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.js    # POST /api/auth/login
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.js        # GET /api/health
‚îÇ   ‚îú‚îÄ‚îÄ lib/                    # üÜï Backend helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.js               # Conex√£o PostgreSQL
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrate.js          # Script de migrations
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ api.js              # ‚úÖ Atualizado para /api
‚îú‚îÄ‚îÄ .env.local                  # üÜï Vari√°veis de ambiente
‚îî‚îÄ‚îÄ package.json                # ‚úÖ pg adicionado</code></pre>

        <h4>Pr√≥ximos passos:</h4>
        <ul>
          <li>Implementar hash de senhas com bcrypt</li>
          <li>Adicionar JWT tokens para autentica√ß√£o real</li>
          <li>Implementar valida√ß√£o com Zod ou Yup</li>
          <li>Adicionar pagina√ß√£o nos endpoints</li>
          <li>Implementar filtros e busca</li>
          <li>Adicionar logs e monitoring</li>
          <li>Implementar rate limiting</li>
          <li>Adicionar testes unit√°rios e de integra√ß√£o</li>
        </ul>

        <div class="alert alert-success">
          <strong>üéâ Parab√©ns!</strong> Voc√™ agora sabe como criar uma API
          completa dentro do Next.js e conectar com PostgreSQL. Esta √© a base de
          aplica√ß√µes full-stack modernas!
        </div>
      </div>
    </div>
  </section>
</article>
