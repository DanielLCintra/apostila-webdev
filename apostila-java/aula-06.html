<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula 06 - Limpando e Modularizando</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Voltar ao Menu</a>
            <h1>Aula 06 - Limpando e Modularizando</h1>
            <p class="subtitle">DTOs, valida√ß√µes, tratamento de erros e organiza√ß√£o</p>
        </header>

        <div class="content">
            <section class="section">
                <h2>üìö Conectando com as Aulas Anteriores</h2>
                <div class="concept-box">
                    <p>
                        Nas <strong>Aulas 03, 04 e 05</strong>, voc√™ criou APIs REST com Spring Boot, aprendeu JPA 
                        para persistir dados e como debugar e testar seu c√≥digo. Agora vamos <strong>melhorar a qualidade 
                        e organiza√ß√£o</strong> do c√≥digo usando DTOs, valida√ß√µes e tratamento de erros.
                    </p>
                    <p>
                        <strong>O que voc√™ j√° sabe:</strong> Spring Boot, JPA, Controllers, Services, Repositories, 
                        testes b√°sicos
                    </p>
                    <p>
                        <strong>O que vamos aprender agora:</strong> DTOs (separar modelo de dom√≠nio da API), 
                        Bean Validation, tratamento global de erros com @ControllerAdvice e como organizar melhor 
                        seu c√≥digo
                    </p>
                    <div class="tip-box">
                        <strong>üí° Por que isso √© importante?</strong> At√© agora voc√™ provavelmente est√° retornando 
                        entidades JPA diretamente nos controllers. Isso funciona, mas n√£o √© uma boa pr√°tica. 
                        Vamos aprender a fazer do jeito certo!
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>üì¶ DTOs (Data Transfer Objects)</h2>
                
                <div class="concept-box">
                    <h3>Por que usar DTOs?</h3>
                    <ul>
                        <li>Separar modelo de dom√≠nio da API</li>
                        <li>Controlar quais dados s√£o expostos</li>
                        <li>Evitar expor campos internos (como IDs de relacionamento)</li>
                        <li>Facilitar versionamento da API</li>
                        <li>Permitir diferentes representa√ß√µes para entrada e sa√≠da</li>
                    </ul>
                </div>

                <div class="concept-box">
                    <h3>Criando DTOs</h3>
                    <p><strong>Importante:</strong> Para usar as anota√ß√µes de valida√ß√£o, voc√™ precisa adicionar a depend√™ncia <code>spring-boot-starter-validation</code> (veja se√ß√£o de Valida√ß√µes abaixo) e importar as anota√ß√µes.</p>
                    <div class="code-block">
<pre>package com.exemplo.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

// DTO para cria√ß√£o (entrada)
public record CriarUsuarioDTO(
    @NotBlank(message = "Nome √© obrigat√≥rio")
    @Size(min = 3, max = 100, message = "Nome deve ter entre 3 e 100 caracteres")
    String nome,
    
    @NotBlank(message = "Email √© obrigat√≥rio")
    @Email(message = "Email inv√°lido")
    String email
) {}

// DTO para resposta (sa√≠da)
public record UsuarioResponseDTO(
    Long id,
    String nome,
    String email,
    LocalDateTime dataCriacao
) {
    public static UsuarioResponseDTO from(Usuario usuario) {
        return new UsuarioResponseDTO(
            usuario.getId(),
            usuario.getNome(),
            usuario.getEmail(),
            usuario.getDataCriacao()
        );
    }
}

// DTO para atualiza√ß√£o
public record AtualizarUsuarioDTO(
    @Size(min = 3, max = 100)
    String nome,
    
    @Email
    String email
) {}

// DTO para resposta (sa√≠da) - n√£o precisa valida√ß√µes
public record UsuarioResponseDTO(
    Long id,
    String nome,
    String email,
    LocalDateTime dataCriacao
) {
    // M√©todo est√°tico para converter de Entidade para DTO
    public static UsuarioResponseDTO from(Usuario usuario) {
        return new UsuarioResponseDTO(
            usuario.getId(),
            usuario.getNome(),
            usuario.getEmail(),
            usuario.getDataCriacao()
        );
    }
}</pre>
                    </div>
                </div>

                <div class="concept-box">
                    <h3>Usando DTOs no Controller</h3>
                    <p><strong>Importante:</strong> Use <code>@Valid</code> nos par√¢metros <code>@RequestBody</code> para ativar as valida√ß√µes. Sem isso, as anota√ß√µes de valida√ß√£o n√£o funcionam!</p>
                    <div class="code-block">
<pre>package com.exemplo.controller;

import com.exemplo.dto.CriarUsuarioDTO;
import com.exemplo.dto.UsuarioResponseDTO;
import com.exemplo.service.UsuarioService;
import jakarta.validation.Valid;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/usuarios")
public class UsuarioController {
    
    private final UsuarioService usuarioService;
    
    // Inje√ß√£o via construtor (boa pr√°tica)
    public UsuarioController(UsuarioService usuarioService) {
        this.usuarioService = usuarioService;
    }
    
    @PostMapping
    public ResponseEntity&lt;UsuarioResponseDTO&gt; criar(
            @Valid @RequestBody CriarUsuarioDTO dto) {
        // @Valid ativa as valida√ß√µes do Bean Validation
        // Se valida√ß√£o falhar, retorna 400 Bad Request automaticamente
        Usuario usuario = new Usuario(dto.nome(), dto.email());
        Usuario usuarioSalvo = usuarioService.criar(usuario);
        return ResponseEntity.status(HttpStatus.CREATED)
            .body(UsuarioResponseDTO.from(usuarioSalvo));
    }
    
    @GetMapping("/{id}")
    public ResponseEntity&lt;UsuarioResponseDTO&gt; buscar(@PathVariable Long id) {
        Usuario usuario = usuarioService.buscarPorId(id)
            .orElseThrow(() -&gt; new RuntimeException("Usu√°rio n√£o encontrado"));
        return ResponseEntity.ok(UsuarioResponseDTO.from(usuario));
    }
}</pre>
                    </div>
                    <div class="tip-box">
                        <strong>üí° Por que @Valid √© importante?</strong> Sem <code>@Valid</code>, o Spring n√£o executa as valida√ß√µes definidas nas anota√ß√µes. 
                        Sempre use <code>@Valid</code> em par√¢metros <code>@RequestBody</code> que t√™m anota√ß√µes de valida√ß√£o.
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>‚úÖ Valida√ß√µes com Bean Validation</h2>
                
                <div class="step-box">
                    <h3>1. Adicionar Depend√™ncia</h3>
                    <div class="code-block">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
                    </div>
                </div>

                <div class="concept-box">
                    <h3>Anota√ß√µes de Valida√ß√£o</h3>
                    <p><strong>Importante:</strong> As anota√ß√µes de valida√ß√£o v√™m do pacote <code>jakarta.validation.constraints</code> (ou <code>javax.validation.constraints</code> em vers√µes antigas do Spring Boot).</p>
                    <div class="code-block">
<pre>package com.exemplo.dto;

import jakarta.validation.constraints.*;

public record CriarTarefaDTO(
    @NotBlank(message = "T√≠tulo √© obrigat√≥rio")
    @Size(min = 3, max = 200, message = "T√≠tulo deve ter entre 3 e 200 caracteres")
    String titulo,
    
    @Size(max = 1000, message = "Descri√ß√£o n√£o pode ter mais de 1000 caracteres")
    String descricao,
    
    @NotNull(message = "Data de vencimento √© obrigat√≥ria")
    @Future(message = "Data de vencimento deve ser no futuro")
    LocalDateTime dataVencimento,
    
    @Min(value = 1, message = "Prioridade deve ser entre 1 e 5")
    @Max(value = 5, message = "Prioridade deve ser entre 1 e 5")
    Integer prioridade
) {}</pre>
                    </div>
                    <div class="tip-box">
                        <strong>üí° Spring Boot 3.x:</strong> Use <code>jakarta.validation</code> (n√£o <code>javax.validation</code>). 
                        Se voc√™ estiver usando Spring Boot 2.x, use <code>javax.validation</code>.
                    </div>
                </div>

                <div class="concept-box">
                    <h3>Anota√ß√µes Mais Comuns</h3>
                    <ul>
                        <li><code>@NotNull</code> - N√£o pode ser null</li>
                        <li><code>@NotBlank</code> - N√£o pode ser null, vazio ou s√≥ espa√ßos (String)</li>
                        <li><code>@NotEmpty</code> - N√£o pode ser null ou vazio</li>
                        <li><code>@Size(min, max)</code> - Tamanho de String/Collection</li>
                        <li><code>@Min</code>, <code>@Max</code> - Valores num√©ricos</li>
                        <li><code>@Email</code> - Formato de email v√°lido</li>
                        <li><code>@Past</code>, <code>@Future</code> - Datas</li>
                        <li><code>@Pattern</code> - Regex</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <h2>üõ°Ô∏è Tratamento Global de Erros</h2>
                
                <div class="concept-box">
                    <h3>@ControllerAdvice - Handler Global</h3>
                    <div class="code-block">
<pre>package com.exemplo.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {
    
    // Trata erros de valida√ß√£o
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleValidationErrors(
            MethodArgumentNotValidException ex) {
        
        Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();
        ex.getBindingResult().getAllErrors().forEach((error) -&gt; {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });
        
        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
        response.put("timestamp", LocalDateTime.now());
        response.put("status", HttpStatus.BAD_REQUEST.value());
        response.put("errors", errors);
        
        return ResponseEntity.badRequest().body(response);
    }
    
    // Trata exce√ß√µes gen√©ricas
    @ExceptionHandler(RuntimeException.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleRuntimeException(
            RuntimeException ex) {
        
        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
        response.put("timestamp", LocalDateTime.now());
        response.put("status", HttpStatus.BAD_REQUEST.value());
        response.put("message", ex.getMessage());
        
        return ResponseEntity.badRequest().body(response);
    }
    
    // Trata recursos n√£o encontrados
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleResourceNotFound(
            ResourceNotFoundException ex) {
        
        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
        response.put("timestamp", LocalDateTime.now());
        response.put("status", HttpStatus.NOT_FOUND.value());
        response.put("message", ex.getMessage());
        
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }
}</pre>
                    </div>
                </div>

                <div class="concept-box">
                    <h3>Exce√ß√£o Customizada</h3>
                    <div class="code-block">
<pre>public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String message) {
        super(message);
    }
    
    public ResourceNotFoundException(String resource, Long id) {
        super(String.format("%s com id %d n√£o encontrado", resource, id));
    }
}

// Uso no Service
public Usuario buscarPorId(Long id) {
    return usuarioRepository.findById(id)
        .orElseThrow(() -&gt; new ResourceNotFoundException("Usu√°rio", id));
}</pre>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>üìÅ Organiza√ß√£o de Pastas</h2>
                
                <div class="concept-box">
                    <h3>Estrutura Recomendada</h3>
                    <div class="code-block">
<pre>src/main/java/com/exemplo/
‚îú‚îÄ‚îÄ controller/          # Controllers REST
‚îÇ   ‚îî‚îÄ‚îÄ UsuarioController.java
‚îú‚îÄ‚îÄ service/             # L√≥gica de neg√≥cio
‚îÇ   ‚îî‚îÄ‚îÄ UsuarioService.java
‚îú‚îÄ‚îÄ repository/          # Acesso a dados
‚îÇ   ‚îî‚îÄ‚îÄ UsuarioRepository.java
‚îú‚îÄ‚îÄ entity/              # Entidades JPA
‚îÇ   ‚îî‚îÄ‚îÄ Usuario.java
‚îú‚îÄ‚îÄ dto/                 # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ request/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CriarUsuarioDTO.java
‚îÇ   ‚îî‚îÄ‚îÄ response/
‚îÇ       ‚îî‚îÄ‚îÄ UsuarioResponseDTO.java
‚îú‚îÄ‚îÄ exception/           # Exce√ß√µes customizadas
‚îÇ   ‚îú‚îÄ‚îÄ GlobalExceptionHandler.java
‚îÇ   ‚îî‚îÄ‚îÄ ResourceNotFoundException.java
‚îî‚îÄ‚îÄ config/              # Configura√ß√µes
    ‚îî‚îÄ‚îÄ AppConfig.java</pre>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>‚öôÔ∏è Bean Configuration</h2>
                
                <div class="concept-box">
                    <h3>@Configuration e @Bean</h3>
                    <p>Use <code>@Configuration</code> para definir beans customizados.</p>
                    
                    <div class="code-block">
<pre>package com.exemplo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class AppConfig {
    
    // Bean para RestTemplate (cliente HTTP)
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    // Bean para ObjectMapper customizado
    @Bean
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        mapper.findAndRegisterModules();
        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
        return mapper;
    }
}</pre>
                    </div>
                </div>

                <div class="tip-box">
                    <strong>üí° Quando usar @Bean:</strong>
                    <ul>
                        <li>Configurar bibliotecas de terceiros</li>
                        <li>Criar objetos complexos que precisam de configura√ß√£o</li>
                        <li>Definir beans que ser√£o injetados em m√∫ltiplos lugares</li>
                        <li>Configurar componentes que n√£o s√£o suas classes</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <h2>‚úÖ Checklist da Aula 06</h2>
                <div class="challenge-box">
                    <p>Antes de ir para a pr√≥xima aula, certifique-se de que:</p>
                    <ul>
                        <li>‚úÖ Entendeu por que usar DTOs (separar dom√≠nio da API)</li>
                        <li>‚úÖ Criou DTOs de request e response usando Records</li>
                        <li>‚úÖ Adicionou depend√™ncia spring-boot-starter-validation</li>
                        <li>‚úÖ Usou anota√ß√µes de valida√ß√£o (@NotBlank, @Email, @Size)</li>
                        <li>‚úÖ Usou @Valid nos controllers para ativar valida√ß√µes</li>
                        <li>‚úÖ Criou GlobalExceptionHandler com @ControllerAdvice</li>
                        <li>‚úÖ Tratou MethodArgumentNotValidException</li>
                        <li>‚úÖ Organizou pastas (controller, service, dto, exception)</li>
                        <li>‚úÖ Entendeu a diferen√ßa entre entidade JPA e DTO</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <h2>üí° Boas Pr√°ticas</h2>
                
                <div class="tip-box">
                    <ul>
                        <li><strong>Use DTOs:</strong> Nunca exponha entidades JPA diretamente</li>
                        <li><strong>Valide na entrada:</strong> Use <code>@Valid</code> em todos os DTOs de entrada</li>
                        <li><strong>Trate erros globalmente:</strong> Use <code>@ControllerAdvice</code> para centralizar tratamento</li>
                        <li><strong>Organize por camadas:</strong> Separe controller, service, repository, dto</li>
                        <li><strong>Use records para DTOs:</strong> Reduz boilerplate e garante imutabilidade</li>
                        <li><strong>Mensagens de erro claras:</strong> Ajudam desenvolvedores frontend</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <h2>üß† Exerc√≠cio Pr√°tico</h2>
                <div class="challenge-box">
                    <h3>Refatorar Projeto com DTOs e Valida√ß√µes</h3>
                    <p><strong>Objetivo:</strong> Aplicar todas as pr√°ticas aprendidas.</p>
                    
                    <h4>Tarefas:</h4>
                    <ol>
                        <li>Crie DTOs de request e response para sua entidade principal</li>
                        <li>Adicione valida√ß√µes nos DTOs de entrada</li>
                        <li>Implemente <code>@ControllerAdvice</code> para tratamento global</li>
                        <li>Crie exce√ß√µes customizadas (ResourceNotFoundException, etc.)</li>
                        <li>Reorganize pastas seguindo a estrutura recomendada</li>
                        <li>Teste valida√ß√µes enviando dados inv√°lidos via Postman</li>
                    </ol>
                </div>
            </section>

            <nav class="lesson-nav">
                <a href="aula-05.html" class="nav-link">‚Üê Aula Anterior</a>
                <a href="index.html" class="nav-link">Menu Principal</a>
                <a href="aula-07.html" class="nav-link">Pr√≥xima Aula ‚Üí</a>
            </nav>
        </div>
    </div>
</body>
</html>

